<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHIS2 Data Synchronization Tool</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007bff">
    <meta name="description" content="Web application for transferring data between DHIS2 instances with intelligent sync detection">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="DHIS2 Exchange">
    <meta name="msapplication-TileColor" content="#007bff">
    <meta name="msapplication-config" content="/static/browserconfig.xml">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-16x16.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <!-- Vanilla JavaScript - No WebSocket Dependencies -->
    <script src="/static/js/app.js?v=3"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .main-header {
            background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(13, 110, 253, 0.2);
        }
        .nav-tabs .nav-link {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            margin-right: 0.25rem;
            border-radius: 0.5rem 0.5rem 0 0;
            color: #6c757d;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .nav-tabs .nav-link:hover {
            border-color: transparent;
            background: #f8f9fa;
            color: #0d6efd;
        }
        .nav-tabs .nav-link.active {
            background: white;
            color: #0d6efd;
            border: 1px solid #dee2e6;
            border-bottom-color: white;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }
        .nav-tabs {
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 0;
        }
        .tab-content {
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            padding: 2rem;
            min-height: 500px;
        }
        /* Global UI normalization for consistent spacing & sizing */
        .btn {
            padding: 0.5rem 1rem;
            min-height: 2.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .btn i { margin-right: 0.35rem; }
        .form-control, .form-select {
            min-height: 2.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
        }
        .form-label {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        .input-group > .form-control,
        .input-group > .form-select,
        .input-group > .btn { height: 2.5rem; }
        .badge { padding: 0.4em 0.6em; border-radius: 0.4rem; }
        /* Reusable responsive action bar */
        .action-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; }
        @media (max-width: 576px) {
            .action-bar .btn { flex: 1 1 100%; }
        }
        .tab-icon {
            margin-right: 0.5rem;
            font-size: 1.1rem;
        }
        .status-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.75rem;
        }
        .card-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }
        .connection-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .connection-status.connected {
            background: #198754;
        }
        .connection-status.disconnected {
            background: #dc3545;
        }
        .connection-status.unknown {
            background: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="main-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1">DHIS2 Data Synchronization Tool</h1>
                    <p class="mb-0 opacity-75">Manage data transfers and completeness between DHIS2 instances</p>
                </div>
                <div class="text-end">
                    <div class="small opacity-75">Connection Status</div>
                    <div>
                        <span class="connection-status unknown"></span>
                        <small>Ready to Connect</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" 
                        data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">
                    <i class="bi bi-speedometer2 tab-icon"></i>Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" 
                        data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">
                    <i class="bi bi-gear tab-icon"></i>Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="transfer-tab" data-bs-toggle="tab" 
                        data-bs-target="#transfer" type="button" role="tab" aria-controls="transfer" aria-selected="false">
                    <i class="bi bi-arrow-left-right tab-icon"></i>Transfer
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="completeness-tab" data-bs-toggle="tab" 
                        data-bs-target="#completeness" type="button" role="tab" aria-controls="completeness" aria-selected="false">
                    <i class="bi bi-check-circle tab-icon"></i>Completeness
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                {% include "partials/dashboard_content.html" %}
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                {% include "partials/settings_content.html" %}
            </div>

            <!-- Transfer Tab -->
            <div class="tab-pane fade" id="transfer" role="tabpanel" aria-labelledby="transfer-tab">
                {% include "partials/transfer_content.html" %}
            </div>

            <!-- Completeness Tab -->
            <div class="tab-pane fade" id="completeness" role="tabpanel" aria-labelledby="completeness-tab">
                {% include "partials/completeness_content.html" %}
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // Show update available notification
                                        showUpdateAvailable();
                                    }
                                }
                            });
                        });
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        function showInstallPrompt() {
            const installBanner = document.createElement('div');
            installBanner.className = 'alert alert-info alert-dismissible fade show';
            installBanner.innerHTML = `
                <strong>Install App</strong> Add DHIS2 Exchange to your home screen for quick access!
                <button type="button" class="btn btn-sm btn-primary ms-2" onclick="installApp()">Install</button>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(installBanner, document.querySelector('.nav'));
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                });
            }
        }

        function showUpdateAvailable() {
            const updateBanner = document.createElement('div');
            updateBanner.className = 'alert alert-warning alert-dismissible fade show';
            updateBanner.innerHTML = `
                <strong>Update Available</strong> A new version is ready!
                <button type="button" class="btn btn-sm btn-warning ms-2" onclick="updateApp()">Refresh</button>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(updateBanner, document.querySelector('.nav'));
        }

        function updateApp() {
            window.location.reload();
        }

        // Progress polling functionality is now handled by app.js DHISApp.pollProgress()
        // This maintains compatibility with existing progress tracking
        function startProgressPolling(taskId) {
            if (window.dhisApp) {
                return window.dhisApp.pollProgress(taskId);
            } else {
                console.warn('DHISApp not loaded, falling back to basic polling');
                // Fallback implementation
                const interval = setInterval(async () => {
                    try {
                        const response = await fetch(`/progress/${taskId}`);
                        const data = await response.json();
                        
                        if (data.status === 'completed' || data.status === 'error') {
                            clearInterval(interval);
                        }
                    } catch (error) {
                        console.error('Progress polling error:', error);
                        clearInterval(interval);
                    }
                }, 2000);
                return interval;
            }
        }

        // Ensure Completeness tab initializes its scripts when shown
        document.getElementById('completeness-tab').addEventListener('shown.bs.tab', () => {
            try { if (window.startCompletenessInit) window.startCompletenessInit(); } catch (e) { console.error('Completeness init error', e); }
        });
        // If the tab is active on initial load (deep link), init immediately
        if (document.getElementById('completeness').classList.contains('show') || document.getElementById('completeness').classList.contains('active')) {
            try { if (window.startCompletenessInit) window.startCompletenessInit(); } catch (e) { console.error('Completeness init error', e); }
        }
    </script>
</body>
</html>